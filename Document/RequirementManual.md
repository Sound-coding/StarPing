# 需求规格说明书

## 目录
1. [引言](#引言)
    1. [编写目的](#编写目的)
    2. [项目简介](#项目简介)
    3. [功能范围](#功能范围)
    4. [参考资料](#参考资料)
    5. [术语定义](#术语定义)
2. [总体描述](#总体描述)
    1. [项目背景](#项目背景)
    2. [项目目标](#项目目标)
    3. [典型用户场景](#典型用户场景)
    4. [用户特点](#用户特点)
    5. [典型用户使用场景](#典型用户使用场景)
    6. [用户需求说明](#用户需求说明)
    7. [运行环境要求](#运行环境要求)
3. [前提与假设](#前提与假设)
4. [系统功能描述验收标准](#系统功能描述验收标准)
    1. [系统稳定性要求](#系统稳定性要求)
    2. [系统功能性要求](#系统功能性要求)
    3. [系统安全性要求](#系统安全性要求)
    4. [文档要求](#文档要求)

## 引言

### 编写目的

本需求规格说明书意在明确系统需求及功能，指导系统的设计与开发工作，并作为结果检验的标准。

本文档面向以下读者：  
 - 项目经理：了解产品预期功能，以本文档为依据进行系统设计和项目管理。  
 - 设计员：分析系统需求，进行系统架构设计。  
 - 程序员：掌握系统功能，作为实现功能和编写用户手册的依据。  
 - 测试员：以本文档为参考编写测试用例，对产品进行功能性和非功能性测试。  
 - 终端用户：了解产品预期功能，提供改进意见。  

### 项目简介

项目名称：StarPing  
目标用户：网络服务提供商，网站运营人员，极客用户  
开发团队：None Team

### 功能范围

Planet模块：系统边缘节点，监测节点，用于收集目标服务器的延迟和路由信息。  
Star模块（后端）：系统中心节点，存储数据，提供API响应数据请求。  
Star模块（前端）：网页用户界面，以图表向用户展现数据。  

### 参考资料

《构建之法》(第二版)，邹欣。  
技术文档。  
博客及问答网站。  

### 术语定义

| 名称 | 定义 |
| --- | --- |
| IP | 网际协议，亦指此协议下为主机分配的地址 |
| ICMP | Internet Control Message Protocol (互联网控制消息协议)，用于在IP协议中传输控制消息，提供可能发生在通信环境中的各种问题反馈，使管理者可以对所发生的问题作出诊断，然后采取适当的措施解决。|
| Ping | 一种计算机工具，用来测试数据包能否透过IP协议到达特定主机。亦指进行测试的这一行为 |
| Echo | ICMP Echo 数据包，ping工具发送的ICMP数据包 |
| TTL | IP协议头中一个字段，指示该数据包在经过其数值个数的路由后应当被丢弃，并发回相应消息 |
| amd64-linux(及类似名称) | 指示系统环境。-前部分表示CPU架构，-后部分表示系统名称 |
| PostgreSQL | 以加州大学伯克利分校计算机系开发的POSTGRES为基础的对象关系型数据库管理系统（ORDBMS）|
| Chrome | Google 开发的浏览器 |
| Firefox | Mozilla 开发的浏览器 |
| Safari | Apple 开发的浏览器 |
| Edge | Microsoft 开发的浏览器 |
| IE | Internet Explorer，Microsoft 开发的浏览器，现已不推荐使用 |
| Backend（后端） | 网站中指在网站管理员控制的计算机中运行的程序部分 |
| Frontend（前端） | 网站中指在用户控制的计算机中运行的程序部分 |
| API | Application Programming Interface，应用程序接口，指软件系统不同组成部分衔接的约定。|

## 总体描述

### 项目背景

互联网时代，大量服务都依托于网络构建，而服务的稳定性是决定服务质量最为基础但又最为重要的因素之一。但另一方面，对于负责搭建和维护的运营人员来说，如何判断基础网络服务的稳定性，则是一个困难的问题。服务提供商一般只会提供粗糙的数字，并且还存在着夸大宣传、选择性宣传的状况，而自行测试又只能反映出某一个时间点在某一个特定网络状况下的表现，较为片面；如果要长时间测试，需要大量时间，经常不可行；如果选择试用，在多个服务提供商间重复部署服务和迁移服务带来的额外人工成本也十分之高。

### 项目目标

本项目针对上述项目背景，提供一整套的监测-收集-展示系统，向访问者提供长期监测的服务延迟数据，帮助访问者对服务的稳定性作出全面客观的评价。

### 典型用户场景

#### 场景1

赵明是网络服务的提供商，他想以详实的数据证明自己的服务质量，以赢得潜在客户的选择；他也希望能对自己的服务进行监控，以发现潜在的问题从而进行解决，提升服务质量，赢得用户口碑，做大自己的服务规模。他将Star模块部署在自己的一台服务器上，把Planet模块部署在自己各个提供服务的网络节点上，将目标设置为网站访问者使用的家用ISP的IP地址，记录自己的网络到访问者的连接质量，并提供给潜在的用户查看；此外，他自己也会查看记录的数据，分析系统记录的网络波动的产生原因，并采取针对性措施解决问题。

#### 场景2

孙亮是一家公司的网站维护员，他就职的公司涉及到国际业务，需要保证公司网站在全球各地的访问体验。公司在各地都租用了服务器，需要监控各地用户访问网站的体验。由于跨地区访问难以反应当地用户的真实体验，他需要反复登录到各个服务器上排查连接性问题。他需要StarPing系统能够持续收集服务器到目标用户的连接状况，并在出现异常时通知他进行进一步的处理，如通知服务商解决问题等。此外，在公司开拓新市场时需要选购当地的网络服务接入，因而也需要一个能够在事前监测候选服务商服务质量的工具。

#### 场景3

张先是一个资深网络技术爱好者，自己维护了几个网站，也热心地帮助圈子里的其他人，根据对方的需求，选择合适的服务商推荐给他们搭建所需要的网络服务。他关心各个服务商服务质量的真实水平，也希望自己给出的建议是客观准确的。他将Star模块搭建成网站，并联系好友将Planet模块运行在朋友们各自所在的不同网络下。由于需要持续收集信息，设备需要24小时工作，Planet模块需要在各种低功耗的嵌入式设备上运行。

#### 场景4

王华是一名计算机专业的学生，想要开设一个博客记录自己的学习过程和心得体会。他希望能够以较为实惠的价格购买较为稳定的网络服务来支持他的网站，但是面对市面上大大小小良莠不齐的服务商，不知道该怎么选择。他希望有客观全面的数据，能够帮助他挑选出在自己预算范围内较好的服务提供商，来托管自己的网站。

### 用户特点

本系统的最终用户为有一定计算机知识基础的用户，他们较为重视系统的实用性，因而系统的用户操作界面应当简洁方便，允许用户快速获取到自己需要的信息。  
本系统的维护人员为具有较强专业能力的网络行业从业者及爱好者，应当为系统提供详细的文档和简便的二次开发支持，方便他们在此之上扩展功能。

### 典型用户使用场景

典型用户：孙亮
用户的需求/迫切需要解决的问题:
1:孙亮:任职公司拥有数十个国家的外贸用户群，经常有客户反应网站时慢时快，有时还无法打开。
2:孙亮:公司在全球租用了服务器，这些服务器分别运行着不同的业务，由于服务较多，关联性很强，一旦有一个服务掉线就会影响整个系统。
3:孙亮:因外贸用户群分散在各地，想要集中测试各种主要来源国的客户网络骨干网状态从而选择合适的线路。孙亮自己设计的批量延迟检测脚本无法直观的显示各个时段各条线路的延迟状态与链路质量情况。
假设：
孙亮在公司任职数年，且尝试过类似的服务监控系统。
因为网络服务器故障未得到及时处理，孙亮的公司在一个地区的业务开展一段时间内出现较为严重的问题。

场景：
公司将要开拓S地区市场，孙亮想要统计该地区各服务商的网络到A、B、C、D、E五个家庭宽带运营商骨干网的节点链接状态，此时他使用了Starping。  
同时，孙亮也需要监测公司所有已有服务器的可用性，确保服务不出现网络连接出现波动导致影响用户体验而未及时发觉的情况。  
孙亮在自己公司的总部服务器上配置好StarPing的服务端，在需要运行可用性监测的服务器上运行客户端，通过连接到位于总部的服务器，孙亮便可以随时浏览各服务器到客户网络的连接状况。  
孙亮在总部服务器上针对已有地区的节点设置了故障提醒，当连接状况超出了他所设定的告警阈值后，他就可以及时收到系统发出的告警信息。（孙亮可以自行编写程序来完成复杂和定制化的报警通知方式）第一时间收到告警信息后，他可以登录StarPing系统查看最近的连接状况，以及系统收集的更加详细的信息，并根据得到的数据，连接到远程服务器，进一步对问题进行排查，快速锁定问题是出现在服务器器还是客户使用的网络，大大缩短了从问题出现到采取相应措施的时间，避免了服务长时间难以访问导致的不良后果。  
某一天，孙亮收到系统发送的警告消息，虽然服务没有完全中断但延迟异常升高，并伴随有丢包率的增加。由于访问并没有完全中断，等待更长的时间后同样可以打开网页。依照以往的经验，忠实用户倾向于耐心等待，并不会报告问题，而一般用户则会失去耐心，直接离开，而不会报告问题，这样的故障很可能会持续一段时间不被发觉，在不知情的情况下导致用户流失。收到系统警告后孙亮迅速打开StarPing系统查看图表信息，得知此现象在到当地各个运营商网络均有发生，他推断是服务商处的网络问题，于是立刻联系服务器提供商。服务商的团队迅速作出响应进行排查，发现是同网络下另一台服务器正在向外发起网络攻击产生了大量流量，进而影响到了同网络下的其他服务器的网络连接。服务商迅速关停了问题服务器，并通知该服务器用户排查安全问题，检查是否被恶意程序入侵利用。之后，网络连接恢复了正常。  
孙亮在网站出现问题时可以依次检查到各种目标的延迟状况：  
- 查询服务商网络出口节点状况  
- 查询当地骨干运营商节点状况  
- 查询当地用户家庭运营商节点状况  
- 查询当地其他服务器机房状况  
- 查询当地服务器到公司主服务器的连接状况  

在孙亮利用Starping查询的过程中，路由追踪的作用是分析数据传输过程中是哪一个节点发生故障导致网络不稳定。
延迟测试是发现潜在问题的前提。在延迟上升，或者丢包率上升到设定的阈值时，通知孙亮，则孙亮会注意是否有节点发生问题。如果发生问题，则利用路由追踪去查询。  
孙亮可以利用图表来直观地观察服务的延迟曲线，判断何时为高负载时间，何时为低负载时间，可以更好地针对时段进行服务调度，以防服务在高负载时过载。或者不可用等情况出现。  
孙亮可以综合利用Starping的图形，延迟，丢包率，路由追踪来判断客户反映的无法使用或者效果差是发生在服务端，还是骨干网链中，还是客户的问题。进而迅速排查并解决故障，为正常服务提供了许多便利。  
在非工作时段，孙亮可以暂时忽略非紧急状况，等到上班时段再通过查询StarPing系统中留下的当时的记录，分析当时出现的状况，从而作出进一步的处理。  
孙亮可以通过查看长期统计数据的概览，得出当地服务器的质量水平，在连接质量较不理想时考虑更换服务商等选择。

### 用户需求说明

Planet模块：本模块需要能够在各种设备（包括嵌入式设备）上长期运行，且需要较高的并发支持。  
Star模块（后端）：本模块需要能够在服务器上稳定运行，**且提供方便的二次开发接口，方便用户添加自定义功能。  
Star模块（前端）：本模块要在浏览器中运行，为用户提供方便的浏览和查询体验。

### 运行环境要求

#### Planet模块

* 运行内存: 32MB  
* 存储空间: 16MB 
* 网络连接  
* 管理员权限  
* 系统环境:  
    * 保证可用: amd64-linux  
    * 尽量可用: amd64-windows, 386-linux, 386-windows, arm-linux, arm64-linux, mips-linux, mips64-linux  
    * 理论可用: 其他golang支持的编译目标  

#### Star模块 （后端）

* 系统环境: amd64-linux  
* 运行内存: 1GB  
* 存储空间: 视数据量而定
* 数据库: PostgreSQL
* 公网IP

#### Star模块 （前端）
* 浏览器支持: 
    * 保证支持: Chrome, Firefox最新两个版本
    * 尽量支持: Chrome, Firefox, Safari, Edge近一年发布的版本（不主动引入不兼容）
    * 不保证可用: IE
    
## 前提与假设

本系统的用户都有一定程度的计算机网络相关知识。

## 系统功能描述验收标准

### 系统稳定性要求

#### Planet模块

在每分钟收发1000ICMP数据包的负载下稳定工作1周。

### Star模块（后端）

在拥有4个Planet连接的负载下稳定工作1周。

#### Star模块 （前端）

使用保证支持列表中的浏览器访问时功能正常，且浏览器控制台不输出错误。

### 系统功能性要求

| 功能模块 | 实现功能 | 测试功能 | 测试结果 |
|-----------------|----------------|-----------------------------------------------------------------|----------|
| Planet | 收发ICMP数据包 | 向127.0.0.1发送ICMP Echo数据包，应当在1ms内100%收到响应数据包。 |  |
|  | 数据包来源识别 | 向多个IP发送正常/TTL极小的数据包，根据响应获得对应目标IP。 |  |
|  | 数据上报 | 将测得结果数据通过HTTP POST传出。 |  |
| Star (Backend) | 数据接收 | 接收来自Planet的数据，并存入数据库。 |  |
|  | 数据请求 | 根据API参数，返回对应的数据。 |  |
|  | 旧数据压缩 | 自动将超过一个月的旧数据合并计算为时间跨度更大的数据。 |  |
|  | Planet管理 | 增删Planet节点和测试目标。 |  |
| Star (Frontend) | 绘制图表 | 根据后端提供的数据绘制出延迟曲线。 |  |
|  | 表格列出路由 | 将后端提供的路由追踪数据以表格形式呈现。 |  |
|  | 数据请求 | 动态向后端发送HTTP请求获取数据。 |  |
|  | 定时更新 | 周期请求后端获取新数据更新图表。 |  |

### 系统安全性要求

Star模块（后端）能够检查请求是否合法，自动过滤非法请求，并限制请求速度。

### 文档要求

各模块关键函数/类必须有相应文档注释。所有功能尽量有相应文档注释。

<hr>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。